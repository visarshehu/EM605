apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-config-demo
  labels:
    app: mysql-demo
    component: database
    config-example: "true"
spec:
  serviceName: mysql-config-demo-headless
  replicas: 1
  selector:
    matchLabels:
      app: mysql-demo
      component: database
  template:
    metadata:
      labels:
        app: mysql-demo
        component: database
        config-example: "true"
    spec:
      serviceAccountName: mysql-config-sa
      
      # Init container to prepare configuration
      initContainers:
      - name: config-init
        image: busybox:1.35
        command:
        - /bin/sh
        - -c
        - |
          echo "ðŸ”§ Preparing MySQL configuration..."
          
          # Copy base configuration
          cp /config-templates/* /etc/mysql/conf.d/ || true
          
          # Process configuration templates with environment variables
          sed -i "s/{{MAX_CONNECTIONS}}/${MYSQL_MAX_CONNECTIONS}/g" /etc/mysql/conf.d/*.cnf || true
          sed -i "s/{{BUFFER_POOL_SIZE}}/${MYSQL_BUFFER_POOL_SIZE}/g" /etc/mysql/conf.d/*.cnf || true
          sed -i "s/{{LOG_FILE_SIZE}}/${MYSQL_LOG_FILE_SIZE}/g" /etc/mysql/conf.d/*.cnf || true
          
          # Create custom configuration based on environment
          cat > /etc/mysql/conf.d/99-dynamic.cnf << EOF
          [mysqld]
          # Dynamic configuration generated at runtime
          server-id = ${MYSQL_SERVER_ID}
          max_connections = ${MYSQL_MAX_CONNECTIONS}
          innodb_buffer_pool_size = ${MYSQL_BUFFER_POOL_SIZE}
          innodb_log_file_size = ${MYSQL_LOG_FILE_SIZE}
          
          # Environment-specific settings
          general_log = ${MYSQL_GENERAL_LOG}
          slow_query_log = ${MYSQL_SLOW_QUERY_LOG}
          long_query_time = ${MYSQL_LONG_QUERY_TIME}
          
          # Character set from ConfigMap
          character-set-server = utf8mb4
          collation-server = utf8mb4_unicode_ci
          EOF
          
          echo "âœ… Configuration prepared successfully"
          echo "Configuration files:"
          ls -la /etc/mysql/conf.d/
          echo "Dynamic configuration:"
          cat /etc/mysql/conf.d/99-dynamic.cnf
          
        env:
        # MySQL configuration from ConfigMap
        - name: MYSQL_MAX_CONNECTIONS
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: max_connections
        - name: MYSQL_BUFFER_POOL_SIZE
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: innodb_buffer_pool_size
        - name: MYSQL_LOG_FILE_SIZE
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: innodb_log_file_size
        - name: MYSQL_SERVER_ID
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: server_id
        - name: MYSQL_GENERAL_LOG
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: general_log
        - name: MYSQL_SLOW_QUERY_LOG
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: slow_query_log
        - name: MYSQL_LONG_QUERY_TIME
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: long_query_time
        
        volumeMounts:
        - name: config-templates
          mountPath: /config-templates
          readOnly: true
        - name: mysql-config-volume
          mountPath: /etc/mysql/conf.d
        
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
      
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - name: mysql
          containerPort: 3306
        
        # Environment variables from multiple sources
        env:
        # Database credentials from Secret
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-advanced-secret
              key: root-password
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: mysql-advanced-secret
              key: user-name
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-advanced-secret
              key: user-password
        - name: MYSQL_DATABASE
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: database_name
        
        # Application configuration from ConfigMap
        - name: MYSQL_CHARSET
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: character_set
        - name: MYSQL_COLLATION
          valueFrom:
            configMapKeyRef:
              name: mysql-config-advanced
              key: collation
        
        # Optional: Load entire ConfigMap as environment variables
        envFrom:
        - configMapRef:
            name: mysql-env-config
            optional: true
        - secretRef:
            name: mysql-optional-secrets
            optional: true
        
        # Volume mounts for various configuration types
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
        - name: mysql-config-volume
          mountPath: /etc/mysql/conf.d
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
          readOnly: true
        - name: ssl-certs
          mountPath: /etc/mysql/ssl
          readOnly: true
        - name: custom-scripts
          mountPath: /usr/local/bin/custom
          readOnly: true
        
        # Health checks
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
            - -u
            - root
            - -p$(MYSQL_ROOT_PASSWORD)
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        
        readinessProbe:
          exec:
            command:
            - mysql
            - -h
            - localhost
            - -u
            - root
            - -p$(MYSQL_ROOT_PASSWORD)
            - -e
            - "SELECT 1"
          initialDelaySeconds: 5
          periodSeconds: 2
          timeoutSeconds: 1
        
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      
      # Sidecar container for configuration management
      - name: config-manager
        image: alpine:3.18
        command:
        - /bin/sh
        - -c
        - |
          echo "ðŸ”§ Configuration Manager starting..."
          
          while true; do
            echo "$(date): Checking configuration changes..."
            
            # Check if configuration files have changed
            if [ -f /etc/mysql/conf.d/99-dynamic.cnf ]; then
              echo "Current configuration status: OK"
            else
              echo "WARNING: Dynamic configuration missing"
            fi
            
            # Monitor log files (if enabled)
            if [ -f /var/lib/mysql/general.log ]; then
              echo "General log size: $(du -h /var/lib/mysql/general.log | cut -f1)"
            fi
            
            # Monitor configuration from Secret/ConfigMap changes
            CONFIG_CHECKSUM=$(find /config-templates /secrets -type f -exec md5sum {} \; | md5sum | cut -d' ' -f1)
            echo "Configuration checksum: ${CONFIG_CHECKSUM}"
            
            sleep 60
          done
          
        env:
        - name: CHECK_INTERVAL
          value: "60"
        
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
          readOnly: true
        - name: config-templates
          mountPath: /config-templates
          readOnly: true
        - name: ssl-certs
          mountPath: /secrets
          readOnly: true
        
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
      
      # Define volumes for different configuration types
      volumes:
      - name: mysql-config-volume
        emptyDir: {}
      - name: config-templates
        configMap:
          name: mysql-config-templates
          defaultMode: 0644
      - name: init-scripts
        configMap:
          name: mysql-init-scripts
          defaultMode: 0755
      - name: custom-scripts
        configMap:
          name: mysql-custom-scripts
          defaultMode: 0755
      - name: ssl-certs
        secret:
          secretName: mysql-ssl-secret
          defaultMode: 0600
      
  # Persistent volume for data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi