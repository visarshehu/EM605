---
# Primary configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config-advanced
  labels:
    app: mysql-demo
    component: database
    config-type: primary
data:
  # Database settings
  database_name: "config_demo_db"
  character_set: "utf8mb4"
  collation: "utf8mb4_unicode_ci"
  
  # Performance settings
  max_connections: "200"
  innodb_buffer_pool_size: "512M"
  innodb_log_file_size: "128M"
  innodb_flush_log_at_trx_commit: "1"
  
  # Server settings
  server_id: "1001"
  
  # Logging settings
  general_log: "ON"
  slow_query_log: "ON"
  long_query_time: "2"
  log_queries_not_using_indexes: "ON"
  
  # Binary logging
  log_bin: "mysql-bin"
  binlog_format: "ROW"
  expire_logs_days: "7"
  
  # Security settings
  validate_password_policy: "MEDIUM"
  default_authentication_plugin: "mysql_native_password"

---
# Configuration templates as files
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config-templates
  labels:
    app: mysql-demo
    component: database
    config-type: templates
data:
  # Performance tuning configuration
  performance.cnf: |
    [mysqld]
    # Performance Schema
    performance_schema = ON
    
    # Query Cache (deprecated in 8.0 but shown for example)
    # query_cache_type = 1
    # query_cache_size = 64M
    
    # Connection settings
    max_connections = {{MAX_CONNECTIONS}}
    max_connect_errors = 1000
    max_user_connections = 190
    
    # Buffer settings
    innodb_buffer_pool_size = {{BUFFER_POOL_SIZE}}
    innodb_buffer_pool_instances = 8
    innodb_log_file_size = {{LOG_FILE_SIZE}}
    innodb_log_buffer_size = 16M
    
    # Table settings
    table_open_cache = 2000
    table_definition_cache = 1400
    
    # Temporary table settings
    tmp_table_size = 128M
    max_heap_table_size = 128M
    
    # Thread settings
    thread_cache_size = 8
    thread_stack = 262144
    
  # Security configuration
  security.cnf: |
    [mysqld]
    # Security settings
    local_infile = 0
    skip_show_database = 1
    
    # SSL/TLS settings
    ssl_ca = /etc/mysql/ssl/ca.pem
    ssl_cert = /etc/mysql/ssl/server-cert.pem
    ssl_key = /etc/mysql/ssl/server-key.pem
    
    # Password validation
    validate_password.policy = MEDIUM
    validate_password.length = 8
    validate_password.mixed_case_count = 1
    validate_password.number_count = 1
    validate_password.special_char_count = 1
    
    # Connection limits
    max_connections_per_hour = 0
    max_queries_per_hour = 0
    max_updates_per_hour = 0
    max_user_connections = 0
    
  # Logging configuration
  logging.cnf: |
    [mysqld]
    # Error log
    log_error = /var/lib/mysql/error.log
    
    # General log
    general_log = ON
    general_log_file = /var/lib/mysql/general.log
    
    # Slow query log
    slow_query_log = ON
    slow_query_log_file = /var/lib/mysql/slow.log
    long_query_time = 2
    log_queries_not_using_indexes = ON
    min_examined_row_limit = 1000
    
    # Binary log
    log_bin = /var/lib/mysql/mysql-bin
    binlog_format = ROW
    binlog_row_image = FULL
    expire_logs_days = 7
    max_binlog_size = 1024M
    
    # Relay log
    relay_log = /var/lib/mysql/relay-bin
    relay_log_index = /var/lib/mysql/relay-bin.index

---
# Environment variables ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-env-config
  labels:
    app: mysql-demo
    component: database
    config-type: environment
data:
  # Timezone settings
  TZ: "UTC"
  MYSQL_INIT_CONNECT: "SET NAMES utf8mb4"
  
  # Application settings
  APP_NAME: "ConfigDemo"
  APP_VERSION: "1.0.0"
  APP_ENVIRONMENT: "development"
  
  # Monitoring settings
  ENABLE_METRICS: "true"
  METRICS_PORT: "9104"
  
  # Backup settings
  BACKUP_ENABLED: "true"
  BACKUP_RETENTION_DAYS: "30"

---
# Initialization scripts ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-init-scripts
  labels:
    app: mysql-demo
    component: database
    config-type: scripts
data:
  # Schema initialization
  01-create-schema.sql: |
    -- Create application database
    CREATE DATABASE IF NOT EXISTS config_demo_db;
    USE config_demo_db;
    
    -- Create application user with specific privileges
    CREATE USER IF NOT EXISTS 'app_user'@'%' IDENTIFIED BY 'app_secure_password';
    GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON config_demo_db.* TO 'app_user'@'%';
    
    -- Create demo tables
    CREATE TABLE IF NOT EXISTS config_settings (
        id INT AUTO_INCREMENT PRIMARY KEY,
        setting_key VARCHAR(100) NOT NULL UNIQUE,
        setting_value TEXT,
        setting_type ENUM('string', 'number', 'boolean', 'json') DEFAULT 'string',
        is_secret BOOLEAN DEFAULT FALSE,
        description TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        INDEX idx_key (setting_key),
        INDEX idx_type (setting_type)
    );
    
    CREATE TABLE IF NOT EXISTS configuration_history (
        id INT AUTO_INCREMENT PRIMARY KEY,
        setting_key VARCHAR(100) NOT NULL,
        old_value TEXT,
        new_value TEXT,
        changed_by VARCHAR(100),
        change_reason VARCHAR(255),
        changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_key (setting_key),
        INDEX idx_changed_at (changed_at)
    );
    
    -- Insert sample configuration data
    INSERT INTO config_settings (setting_key, setting_value, setting_type, is_secret, description) VALUES
    ('app.name', 'ConfigDemo Application', 'string', FALSE, 'Application name'),
    ('app.version', '1.0.0', 'string', FALSE, 'Application version'),
    ('app.debug', 'true', 'boolean', FALSE, 'Debug mode enabled'),
    ('app.max_connections', '100', 'number', FALSE, 'Maximum database connections'),
    ('app.session_timeout', '3600', 'number', FALSE, 'Session timeout in seconds'),
    ('features.analytics', 'true', 'boolean', FALSE, 'Analytics feature enabled'),
    ('features.notifications', 'false', 'boolean', FALSE, 'Notifications feature enabled'),
    ('cache.ttl', '300', 'number', FALSE, 'Cache time-to-live in seconds'),
    ('security.password_policy', '{"min_length": 8, "require_special": true}', 'json', FALSE, 'Password policy configuration');
    
    FLUSH PRIVILEGES;
    
  02-create-users.sql: |
    -- Create additional database users with different privileges
    
    -- Read-only user for reporting
    CREATE USER IF NOT EXISTS 'report_user'@'%' IDENTIFIED BY 'report_readonly_password';
    GRANT SELECT ON config_demo_db.* TO 'report_user'@'%';
    
    -- Backup user
    CREATE USER IF NOT EXISTS 'backup_user'@'%' IDENTIFIED BY 'backup_secure_password';
    GRANT SELECT, LOCK TABLES, SHOW VIEW, EVENT, TRIGGER ON config_demo_db.* TO 'backup_user'@'%';
    
    -- Monitoring user
    CREATE USER IF NOT EXISTS 'monitor_user'@'%' IDENTIFIED BY 'monitor_password';
    GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'monitor_user'@'%';
    GRANT SELECT ON performance_schema.* TO 'monitor_user'@'%';
    
    FLUSH PRIVILEGES;
    
  03-sample-data.sql: |
    -- Insert additional sample data
    USE config_demo_db;
    
    -- More configuration examples
    INSERT INTO config_settings (setting_key, setting_value, setting_type, is_secret, description) VALUES
    ('email.smtp_host', 'smtp.example.com', 'string', FALSE, 'SMTP server hostname'),
    ('email.smtp_port', '587', 'number', FALSE, 'SMTP server port'),
    ('email.use_tls', 'true', 'boolean', FALSE, 'Use TLS for email'),
    ('api.rate_limit', '1000', 'number', FALSE, 'API rate limit per hour'),
    ('api.timeout', '30', 'number', FALSE, 'API timeout in seconds'),
    ('storage.max_file_size', '10485760', 'number', FALSE, 'Maximum file size in bytes'),
    ('ui.theme', 'default', 'string', FALSE, 'Default UI theme'),
    ('ui.language', 'en', 'string', FALSE, 'Default language'),
    ('maintenance.mode', 'false', 'boolean', FALSE, 'Maintenance mode status'),
    ('logging.level', 'info', 'string', FALSE, 'Application logging level');
    
    -- Configuration change history examples
    INSERT INTO configuration_history (setting_key, old_value, new_value, changed_by, change_reason) VALUES
    ('app.debug', 'false', 'true', 'admin', 'Enable debug for troubleshooting'),
    ('features.analytics', 'false', 'true', 'product_manager', 'Enable analytics for user tracking'),
    ('cache.ttl', '600', '300', 'performance_engineer', 'Reduce cache TTL for better data freshness');

---
# Custom scripts ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-custom-scripts
  labels:
    app: mysql-demo
    component: database
    config-type: custom-scripts
data:
  # Health check script
  health-check.sh: |
    #!/bin/bash
    set -e
    
    echo "üè• MySQL Health Check"
    echo "===================="
    
    # Basic connectivity test
    mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1 as connectivity_test;"
    
    # Check database status
    mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW STATUS LIKE 'Threads_connected';"
    mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW STATUS LIKE 'Uptime';"
    
    # Check configuration
    mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW VARIABLES LIKE 'max_connections';"
    mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW VARIABLES LIKE 'innodb_buffer_pool_size';"
    
    echo "‚úÖ Health check completed successfully"
    
  backup-check.sh: |
    #!/bin/bash
    set -e
    
    echo "üíæ Backup System Check"
    echo "====================="
    
    # Check if backup user exists
    mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -e "SELECT User FROM mysql.user WHERE User='backup_user';"
    
    # Test backup functionality
    echo "Testing backup functionality..."
    mysqldump -h localhost -u backup_user -pbackup_secure_password config_demo_db > /tmp/test_backup.sql
    
    if [ -f /tmp/test_backup.sql ]; then
        echo "‚úÖ Backup test successful"
        echo "Backup size: $(du -h /tmp/test_backup.sql | cut -f1)"
        rm -f /tmp/test_backup.sql
    else
        echo "‚ùå Backup test failed"
        exit 1
    fi
    
  config-validator.sh: |
    #!/bin/bash
    set -e
    
    echo "‚öôÔ∏è  Configuration Validator"
    echo "=========================="
    
    # Validate MySQL configuration
    echo "Checking MySQL configuration..."
    
    # Check critical variables
    MAX_CONN=$(mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -sNe "SELECT @@max_connections;")
    BUFFER_SIZE=$(mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} -sNe "SELECT @@innodb_buffer_pool_size;")
    
    echo "Max connections: $MAX_CONN"
    echo "Buffer pool size: $BUFFER_SIZE"
    
    # Validate configuration against requirements
    if [ "$MAX_CONN" -lt 100 ]; then
        echo "‚ö†Ô∏è  Warning: max_connections is less than 100"
    else
        echo "‚úÖ max_connections is adequate"
    fi
    
    # Check if all required tables exist
    echo "Checking required tables..."
    TABLES=$(mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} config_demo_db -sNe "SHOW TABLES;")
    
    for table in "config_settings" "configuration_history"; do
        if echo "$TABLES" | grep -q "$table"; then
            echo "‚úÖ Table $table exists"
        else
            echo "‚ùå Table $table missing"
            exit 1
        fi
    done
    
    echo "‚úÖ Configuration validation completed"